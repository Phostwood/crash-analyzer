<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5X8TRFYCFK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5X8TRFYCFK');
</script>

<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "luzl3ap6kg");
</script>

<title>Crash Log Analyzer</title>

<meta charset="UTF-8">
<meta name="version" content="0.9.6">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/x-icon" 			href="https://phostwood.github.io/crash-analyzer/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" 	href="https://phostwood.github.io/crash-analyzer/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://phostwood.github.io/crash-analyzer/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://phostwood.github.io/crash-analyzer/favicon-16x16.png">
<link rel="manifest" 							href="https://phostwood.github.io/crash-analyzer/site.webmanifest">

<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300i,400,400i,700%7cMarcellus+SC" rel="stylesheet">

<!-- Using stylesheet from Nolvus.net (with Vektor's permission) -->
<link href="https://phostwood.github.io/crash-analyzer/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/turndown@7.0.0/dist/turndown.js"></script>

<style>
/* Fluid Typography Source: https://fluidtypography.com/  */

/* SPECS:
viewport width range: 370 to 4000px
line height range: 1.7 to 1.3 ("Smaller fonts require more line height, which is why you may want to specify a start line height that has a greater value than the end line height (assuming your font size is adjusting proportionally to the viewport's width)." and "For optimal readability and accessibility, try 140% to 180% (that's 1.4 to 1.8)." --> which I'm taking as meaning 1.8 to 1.4)

font size chart:
tag		min	max
code	14	18 (also for textarea)
body	16	22px (also used for button)
h6		17	26
h5		18	30
h4		19	34
h3		20	38
h2		22	42	
h1		24	48	(only heading actually used/specified below)
*/


/* Fluid Typography Fonts */
body, button {
	font-family: "Roboto Condensed", sans-serif;
	font-weight: 400;
	font-size: clamp(1rem, 0.165vw + 0.962rem, 1.375rem);
	line-height: clamp(1.7rem, 0.039vw + 1.691rem, 1.788rem);
}

code, textarea {
    font-family: monospace;
	font-size: clamp(0.875rem, 0.11vw + 0.85rem, 1.125rem);
	line-height: clamp(1.463rem, -0.011vw + 1.49rem, 1.488rem);
}

h1 {
	font-size: clamp(1.5rem, 0.661vw + 1.347rem, 3rem);
	line-height: clamp(2.55rem, 0.595vw + 2.412rem, 3.9rem);
}

h1, h2, h3, h4, h5, h6 {
	font-family: "Marcellus SC",serif;
	font-weight: 600;
}

/* Other Styling */
body {
    background-color: black;
    color: white;
    -webkit-font-smoothing: antialiased;
    margin: 5%;
	margin-top: 1em;
}

#result {
	max-width: 1200px;
}

#footer {
	margin-top: 1em; 
	max-width: 1200px;
}

ol, ul {
	margin-top: 1em;
	margin-bottom: 2em;
	margin-left: 2%;
	margin-right: 2%;
}

li {
    margin-bottom: 1em;
}

a {
	color: #89CFF0; /* Blue color for links */
}

b, strong {
	color: #e08821; /* Nolvus orange color for bold text */
}

code {
	color: #f0c491;
	margin-left: 0;
	padding-left: 0;
}

button, textarea {
	color: black;
    padding: 0.2em 0.4em; /* Padding relative to the font size */
    border: none;
    border-radius: 0.2em; /* Border radius relative to the font size */
}

textarea {
    width: 100%;
    margin: 0.2em;
	margin-left: 0;
    box-sizing: border-box; /* Include padding and border in the element's width */
    padding: 0.5em;
    border: 1px solid #ccc;
    resize: both;
}

button {
	display: inline-block;
	margin-right: 1em; /* Adjust the spacing between buttons */
}

#crashLog.dragover {
	background-color: #d0d0d0; /* Light grey background when dragging over */
}
</style>

<script>
function getPercentAlphabetized(log) {
	// Extract the "Game plugins" section
	var pluginsRegex = /Game plugins \(\d+\)\s*\{[\s\S]*?\}/;
	var pluginsMatch = log.match(pluginsRegex);
	var pluginsSection = pluginsMatch ? pluginsMatch[0] : '';

	// Split the section into lines and filter out non-.esp plugin lines
	var lines = pluginsSection.split('\n').filter(line => line.includes('.esp'));

	// Variables to count alphabetization issues
	var alphabetizedOrderCount = 0;
	var totalEspPlugins = lines.length - 1; // Subtract one because we compare each plugin to the next

	// Check if each .esp plugin is alphabetically ordered
	for (var i = 0; i < totalEspPlugins; i++) {
		// Extract plugin names without the bracketed index
		var currentPluginMatch = lines[i].match(/^\s*\[.*?\]\s*(.+\.esp)$/i);
		var nextPluginMatch = lines[i + 1].match(/^\s*\[.*?\]\s*(.+\.esp)$/i);

		if (currentPluginMatch && nextPluginMatch) {
			var currentPlugin = currentPluginMatch[1].toLowerCase().trim();
			var nextPlugin = nextPluginMatch[1].toLowerCase().trim();
			// Compare plugin names and count if alphabetized
			if (currentPlugin.localeCompare(nextPlugin) < 0) {
				alphabetizedOrderCount++;
				//DEBUGGING: console.log(currentPlugin + ' is alphabetized before ' + nextPlugin); //DEBUGGING
			}
		} else {
			// Handle the case where the line does not contain a .esp file name
			console.error('A line does not contain a .esp file name:', lines[i]); //DEBUGGING
		}
	}
	// Calculate the percentage of alphabetized .esp plugins
	var percentAlphabetized = (alphabetizedOrderCount / totalEspPlugins) * 100;
	//DEBUGGING console.log('percentAlphabetized:',percentAlphabetized); //DEBUGGING
	return percentAlphabetized.toFixed(2); // Return percentage rounded to two decimals
}


function analyzeLog() {
	var log = document.getElementById('crashLog').value;
	var result = '';

	// Extract the "Possible relevant objects" section
	var relevantObjectsRegex = /Possible relevant objects \(\d+\)\s*\{[\s\S]*?\}/;
	var relevantObjectsMatch = log.match(relevantObjectsRegex);
	var relevantObjectsSection = relevantObjectsMatch ? relevantObjectsMatch[0] : '';
	//DEBUGGING: console.log('relevantObjectsSection:' + relevantObjectsSection);

	// Extract the "Probable callstack" section
	var probableCallstackRegex = /Probable callstack\s*\{[\s\S]*?\}/;
	var probableCallstackMatch = log.match(probableCallstackRegex);
	var probableCallstackSection = probableCallstackMatch ? probableCallstackMatch[0] : '';
	//DEBUGGING: console.log('probableCallstackSection:' + probableCallstackSection);


	// Check for .STRINGS crash
	var R14StringsRegex = /R14.*\.STRINGS/; // Regular expression to match "R14" and ".STRINGS" on the same line
	if (R14StringsRegex.test(log)) {
		result += '<li><b>.STRINGS Crash Detected:</b> Remove any unique character in your <b>skyrim.ini</b> file\'s <code>sLanguage=ENGLISH</code> line.  More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-1">.STRINGS Crash</a/>.</li>';
	}
	// Check for D6DDDA crash
	if (log.includes('D6DDDA')) {
		result += '<li><b>D6DDDA Crash Detected:</b> This may occur when either RAM or VRAM has been exceeded or due to broken/corrupt meshes (.nif) or textures (.dds). Verify that you have correctly <a href="https://www.nolvus.net/appendix/pagefile">set your Windows Pagefile Size</a>. If you are playing vanilla Nolvus, and this issue is persistent, it could (rarely) also be an indicator of hardware issues. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-2">D6DDDA Crash</a/>.</li>';
	}
	
	// Check for VRAMr Gorehowl crash (specific variant of D6DDDA crash)
	if (log.includes('D6DDDA') && relevantObjectsSection.includes('Gorehowl')) {
		result += '<li><b>VRAMr Gorehowl Crash Detected:</b> If you are using VRAMr, try temporarily disabling VRAMr\'s output mod to get past the "Night at the Museum" quest, and then re-enable afterwards. Alternately, delete the "gorehowl" .dds and .nif image files. Or, just hide their overrides in MO2. NOTE: the VRAMr mod author is fixing this issue, but old versions could still be in use for a while.</li>';
	}
	
	// Check for Shadow Scene Node crash
	if (probableCallstackSection.includes('BSCullingProcess::unk_D51280+78') && log.includes('(SkyrimSE.exe+12FDD00)')) {
		result += '<li><b>Shadow Scene Node Crash Detected:</b> Load an earlier save, traveling to a different cell from the original crash, and play for a few days in game away from the area. This avoids the Shadow Scene, and hopefully allows the issue to resolve itself. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-3">Shadow Scene Node crash</a/>.</li>';
	}
	// Check for JContainers crash
	if (log.includes('JContainers64.dll+10AE45')) {
		result += '<li><b>JContainers Crash Detected:</b> Go to <a href="https://www.nexusmods.com/skyrimspecialedition/mods/108591?tab=files&file_id=458596">Discrepancy\'s patch settings hub</a> and add the <b>JContainers Crash Workaround</b> mod (from the "Files" section) into Mod Organizer 2 (MO2). If you would like guidance on modding/patching Nolvus, please watch this <a href="https://youtu.be/YOvug9KP5L4">brief tutorial video</a> for step-by-step instructions. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-4">JContainers Crash</a/>.</li>';
	}
	// Check for Gravelord / Mihail Sithis crash
	var matchGravelordMatches = log.match(/mihailmmasithis\.esp/g) || [];
	if (matchGravelordMatches && matchGravelordMatches.length >= 3) {
		result += '<li><b>Gravelord / Mihail Sithis Crash Detected:</b> Go to <a href="https://www.nexusmods.com/skyrimspecialedition/mods/108591">Discrepancy\'s patch settings hub</a> and download the <b>Odin and Gravelords Compatibility Patch﻿</b>. In the installation wizard, for vanilla Nolvus Ascension version 5, choose the top option for the Gravelords Standalone version (mihailmmasithis.esp). This patch can be safely installed mid-game. If you would like guidance on modding/patching Nolvus, please watch this <a href="https://youtu.be/YOvug9KP5L4">brief tutorial video</a> for step-by-step instructions. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-8">Gravelord / Mihail Sithis Crash</a/>.</li>';
	}

	// Check for A0D789 crash
	if (log.includes('(SkyrimSE.exe+A0D789)')) {
		result += '<li><b>A0D789 Crash Detected:</b> Reload game and continue playing, or alternatively, add the <a href="https://www.patreon.com/posts/se-ae-69951525">[SE/AE]A0D789patch</a> patch by kingeric1992 into Mod Organizer (MO2). If you would like guidance on modding/patching Nolvus, please watch this <a href="https://youtu.be/YOvug9KP5L4">brief tutorial video</a> for step-by-step instructions. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-10">A0D789 Crash</a/>.</li>';
	}
	
	// Check for PDPerfPlugin crash
	if (probableCallstackSection.includes('PDPerfPlugin.dll')) {
	result += '<li><b>PDPerfPlugin Crash Detected:</b> If your game crashed on startup, see more information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-11">PDPerfPlugin Crash</a/>.</li>';
	}

	// Check for USVFS crash
	if (probableCallstackSection.includes('usvfs_x64.dll')) {
		result += '<li><b>USVFS Crash Detected:</b> An antivirus (most frequently, Webroot or Bitdefender) is blocking the MO2 file system. Either change your antivirus, or disable your antivirus, and/or create an exception for the entire Nolvus directory. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-12">USVFS Crash</a/>.</li>';
	}
	// Check for Alphabetized Load Order crash
	var percentAlphabetized = getPercentAlphabetized(log);
	if (percentAlphabetized > 70) {
		result += '<li><b>Alphabetized Load Order Detected:</b> This log file\'s .esp mods are ' + percentAlphabetized + '% alphabetized in their load order. Open the Nolvus Dashboard, click on "Manage" then "Instance". Once loaded, click on <b>"Apply Order"</b>.  Also, if you have customized Nolvus with additional mods, review information on the <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-7">Load Order Crash</a>. ⚠️NOTE: Any added mods will be disabled and moved to the bottom of your list, so you\'ll have to manually re-order and re-enable those, but your vanilla Nolvus mods will be returned to their intended order.</li>';
	}
	//SkyrimUpscaler crash
	var skyrimUpscalerMatches = probableCallstackSection.match(/SkyrimUpscaler\.dll/g) || [];
	//DEBUGGING: console.log('SkyrimUpscaler matches:', skyrimUpscalerMatches);
	if (skyrimUpscalerMatches && skyrimUpscalerMatches.length >= 3) {
		result += '<li><b>Possible Skyrim Upscaler Crash Detected:</b> Review the guide, and make sure you have the correct upscaler version for your GPU and that you’ve correctly followed the <a href="https://docs.google.com/document/d/1AWONgaoaQiEUS7UMoC3p01Ht7Zfa_ARAHHg1ve7v-iM/edit">Nolvus DLSS Upscaler Installation Guide</a>. If issue persists, share your crash logs with <a href="https://www.reddit.com/r/Nolvus/">r/Nolvus</a> and/or the <a href="https://discord.gg/Zkh5PwD">Nolvus Discord</a></li>';
	}

	//TODO: Custom mod found in Probable Callstack:  In customized you’ll likely find that there will be many direct mod related crashes which will list themselves. Most of the time it’s as simple as disabling or adjusting the load order of referenced mod

	// Check for Skeleton crash
	var skeletonRegex = /NPC L UpperarmTwist|NPC R UpperarmTwist|skeleton\.nif|skeleton_female\.nif|NPC L Forearm|NPC R Forearm|bisection|NPC SpineX|NPC L Heel|NPC R Heel|NPC L Foot|NPC R Foot|SaddleBone|NPC L Hand|NPC R Hand|NPC L Finger|NPC R Finger/g;
	var skeletonMatches = relevantObjectsSection.match(skeletonRegex) || [];
	if (skeletonMatches.length > 0) {
		result += '<li><b>Possible Skeleton Crash Detected:</b> Your crash log contains '  + skeletonMatches.length +  ' indicator(s) of a skeleton-related crash. If you are playing vanilla Nolvus, restarting the game is the best advice we can currently offer. If you are adding your own mods, check your load order. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-9">Skeleton Crash</a/> and <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-7">Load Order Crash</a>.</li>';
	}

	// Check for Shadowrend crash
	if (relevantObjectsSection.includes('ccbgssse018-shadowrend.esl')) {
		result += '<li><b>Possible Shadowrend Crash Detected:</b> Load an earlier save, travel to a different cell from the original crash, and play for a few in-game days away from the area. This avoids the Shadowrend, and hopefully allows the issue to resolve itself. If you load a shadowrend save and continue playing on it there is a chance the issue can compound upon itself, causing more frequent crashes and issues. ⚠️NOTE: Shadowrend as a probable stack item will appear often, but it can be a misnomer sometimes because it isn\'t always the direct cause of a crash. There are other cases where shadowrend will be listed in the log (many wrong Load Order Crashes will show it) but it won\'t be the direct cause of a crash. More information and troubleshooting tips under <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-6">Shadowrend Crash</a/>.</li>';
	}

	// Default to unknown crash
	if (result == '') {
		result = '<li><b>No recognized crash pattern detected.</b> If you aren\'t aware of (and diligently following) <b>Jerilith\'s Safe Save Guide</b>, review it at <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-5">Save Bloat Crash</a/>. Also, if you have customized Nolvus with additional mods, review information on the <a href="https://www.nolvus.net/catalog/crashlog?acc=accordion-1-7">Load Order Crash</a>. If this issue persists, share your crash logs with <a href="https://www.reddit.com/r/Nolvus/">r/Nolvus</a> and/or the <a href="https://discord.gg/Zkh5PwD">Nolvus Discord</a>.</li>';
	}

	document.getElementById('result').innerHTML = '<ul>' + result + '</ul>';
	showCopyDiagnosisButton();
}

// - - - TODOs - - -

// Beta version 0.9.6:  (hopfully will soon be out of beta)
// ✅Added link to Discrepancy's Nolvus Upscaler Guide.
 


// - - - FUTURE FEATURES? - - -
// ⏸️Special code for Google Analytics conversions and clicks and stuff? (conversion would be a following a diagnosed link to Nolvus.net? CLick would be doing an analysis? Need to read up on the Google Analytics docs.
// ⏸️Display the "Game plugins (2343)" line? 
// ⏸️[INFEASIBLE?] Color syntaxing? Maybe output the "Possible relevant objects" section and the "Probable callstack" with the non-null single quoted names and filenames? Probably need to collect more crash logs from different sources before deciding? 
// ⏸️[INFEASIBLE?] List missing mods? (infeasible without knowing individual install configs?)
// ⏸️[INFEASIBLE?] List non-vanilla mods? (infeasible without a single list of all possible vanilla-Nolvus mods from all possible variants and configurations)
// ⏸️[INFEASIBLE?] Out of order/sequence vanilla mods? (infeasible without a single list of all possible vanilla-Nolvus mods from all possible variants and configurations)
// ⏸️Custom mod found in Probable Callstack:  "In customized you’ll likely find that there will be many direct mod related crashes which will list themselves. Most of the time it’s as simple as disabling or adjusting the load order of referenced mod" (description from Corrupt Bliss)
// ⏸ Find new tests/features in any other Skyrim crash-analysis mods?
// ⏸ Somehow extract mod names from Probable Callstack and above ... and list the ones that show up with their number of occurences?
// ⏸Check for updated version on GitHub? (and alerts user to self-refresh if file is old)
// ⏸ New FaceGen Crash, counting "FaceGen" occurences. Indicate as possible crash. Pending troubleshooting advice. See "maybe Skeleton or Facegen - Crash_2024_4_13_14-6-0.txt"


</script>
</head>


<body>
	<header>
		<h1>Phostwood's Unofficial Nolvus Crash Log Analyzer</h1>
	</header>
	<main>
		<section>
			<p id="versionNumber"></p>
			<p>
				<strong>Find your crash logs at:</strong><br>
				<code id="crashDirectory">[YOUR_DRIVE]\Nolvus\Instances\Nolvus Ascension\MODS\overwrite\NetScriptFramework\Crash</code>
			</p>
			<input type="file" id="fileInput" style="display:none;" onchange="loadFile(event)" accept=".txt">
			<button onclick="document.getElementById('fileInput').click();">Choose File</button>
			<div id="filename"></div>
			<textarea id="crashLog" rows="10" cols="50" placeholder="Choose file (above), or drag-and-drop your log file onto this field, or copy-paste your Nolvus crash log content here..."></textarea><br>
			<button onclick="analyzeLog()">Analyze</button> <button id="convert-button" style="display: none;">Copy Diagnosis</button>
		</section>
		<article id="result"></article>
		<aside id="footer">
			<p>Not all crash types can be detected with this tool. Also, this analysis is very formulaic, and can miss subtleties which may be caught by human analysis.</p>
			<p>For more information on any of these crash types, see <a href="https://www.nolvus.net/catalog/crashlog">Nolvus Crash Log Catalog</a>.</p>
			<p>For a <strong>human analysis</strong>, share your crash logs with <a href="https://www.reddit.com/r/Nolvus/">r/Nolvus</a> and/or the <a href="https://discord.gg/Zkh5PwD">Nolvus Discord</a>.</p>
			<p>If you would like guidance on modding/patching Nolvus, please watch this <a href="https://youtu.be/YOvug9KP5L4">brief tutorial video</a> for step-by-step instructions.</p>
			<p>For additional information on installing mods/patches into Nolvus, see <a href="https://www.reddit.com/r/Nolvus/comments/1btic4j/how_to_links_for_modding_skyrim_on_top_of_nolvus/">🛠️How To: Links for Modding Skyrim on top of Nolvus</a><p>
			<p>Please <strong>report any issues</strong> (or share suggestions) in my <a href="https://www.reddit.com/r/Nolvus/comments/1bzwo0z/unofficial_nolvus_crash_log_analyzer/">r/Nolvus reddit post</a>.</p>
			<p>Thank you to Vektor, Discrepancy, Gaetan, Corrupt Bliss, and CJ for your documentation and/or assistance!</p>
		</aside>
	</main>



<script>
function getVersionNumber() {
	var versionNumber = document.querySelector('meta[name="version"]').getAttribute('content');
	var htmlOutput = '(Beta version ' + versionNumber + ')';
	//TODO? ⚠️You are using an old version. Please refresh your page.⚠️
	return htmlOutput;
}
document.getElementById('versionNumber').innerHTML = getVersionNumber();

// Functions to show or hide the "Copy Diagnosis" button based on content
function hideCopyDiagnosisButton() {
	var button = document.getElementById('convert-button');
	button.style.display = 'none';
}
function showCopyDiagnosisButton() {
	var button = document.getElementById('convert-button');
	button.style.display = 'inline-block';
}

// Clear results on any change to the textarea field
function clearResult() {
		// Only clear the result, not the filename
	document.getElementById('result').innerHTML = '';
	hideCopyDiagnosisButton();
}

// - - -  handle drag-and-drop and "Choose File" button  - - - 

// Functions to handle file selection and load the file content into the textarea
function displayFilename(fileName) {
	var filenameDisplay = document.getElementById('filename');
	filenameDisplay.innerHTML = '<b>Loaded file:</b> <code></code>';
	var codeElement = filenameDisplay.querySelector('code');
	var textNode = document.createTextNode(fileName);
	codeElement.appendChild(textNode);
}

function loadFile(event) {
	var input = event.target;
	var reader = new FileReader();
	reader.onload = function() {
		var text = reader.result;
		document.getElementById('crashLog').value = text;
		displayFilename(input.files[0].name);
		clearResult();
		analyzeLog();
	};
	reader.onerror = function(event) {
		console.error('File reading error:', event.target.error);
	};
	reader.readAsText(input.files[0]);
}

// Function to handle drag and drop with visual feedback, file type validation, and filename display
function handleDragOver(evt) {
	evt.stopPropagation();
	evt.preventDefault();
	evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}

function handleDrop(evt) {
	evt.stopPropagation();
	evt.preventDefault();
	var files = evt.dataTransfer.files; // FileList object.
	if (files.length > 0) {
		var file = files[0];
		if (file.type === 'text/plain') { // Validate file type
			var reader = new FileReader();
			reader.onload = function(event) {
				document.getElementById('crashLog').value = event.target.result;
				displayFilename(file.name);
				clearResult(); // Call clearResult here after setting the value
				analyzeLog();
			};
			reader.onerror = function(event) {
				console.error('File reading error:', event.target.error);
			};
			reader.readAsText(file);
		} else {
			console.error('Unsupported file type:', file.type);
		}
	}
}

// Setup the event listeners for drag and drop with visual feedback
var dropZone = document.getElementById('crashLog');
dropZone.addEventListener('dragover', function(evt) {
	handleDragOver(evt);
	this.classList.add('dragover'); // Add class for visual feedback
}, false);
dropZone.addEventListener('dragleave', function(evt) {
	this.classList.remove('dragover'); // Remove class when dragging leaves
}, false);
dropZone.addEventListener('drop', function(evt) {
	handleDrop(evt);
	this.classList.remove('dragover'); // Remove class on drop
}, false);

// Event listener for changes to the textarea
dropZone.addEventListener('input', function() {
	clearResult() 
}, false);


// - - -  "Copy Diagnosis" button - - - 

// Function to convert HTML to Markdown
function convertHTMLToMarkdown(html) {
	var turndownService = new TurndownService({
	bulletListMarker: '-', // Markdown bullet list marker
	headingStyle: 'atx'    // Markdown heading style
	});
	// Add a rule to handle <li> tags for proper line breaks
	turndownService.addRule('listItem', {
		filter: 'li',
		replacement: function(content) {
			return '\n- ' + content.trim() + '\n'; // Ensure each list item is on a new line
		}
	});
	return turndownService.turndown(html);
}

// Function to copy text to clipboard
function copyToClipboard(text) {
	var dummy = document.createElement("textarea");
	document.body.appendChild(dummy);
	dummy.value = text;
	dummy.select();
	document.execCommand("copy");
	document.body.removeChild(dummy);
}

// Event listener for the "Copy Diagnosis" button
document.getElementById('convert-button').addEventListener('click', function() {
	// Markdown link to be added at the top of the results
	var resultsHeader = 'Results from [Phostwood\'s Unofficial Nolvus Crash Log Analyzer ' + getVersionNumber() + '](https://phostwood.github.io/crash-analyzer/):\n\n';
	var htmlContent = document.getElementById('result').innerHTML;
	var markdown = convertHTMLToMarkdown(htmlContent);
	var finalMarkdown = resultsHeader + markdown;
	copyToClipboard(finalMarkdown);
	alert('Markdown copied to clipboard!');
});
</script>

</body>
</html>
